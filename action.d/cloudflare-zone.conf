[Definition]
actionban = response=$(curl -s -X POST "https://api.cloudflare.com/v4/zones/<cfzone>/firewall/access_rules/rules" \
            -H "Authorization: Bearer <cftoken>" \
            -H "Content-Type: application/json" \
            --data '{"mode":"block","configuration":{"target":"ip","value":"<ip>"},"notes":"Fail2Ban <name>"}'); \
            # Extract the ID of the rule created (Cloudflare returns .result.id for single rule creation)
            id=$(echo "$response" | { jq -r '.result.id // empty' 2>/dev/null || sed -nE 's/.*"result":\{"id":"([^"]+)".*/\1/p'; }); \
            # Optionally also verify the 'success' flag to detect silent failures
            success=$(echo "$response" | { jq -r '.success // false' 2>/dev/null || echo "false"; }); \
            if [ "$success" = "true" ] && [ -n "$id" ]; then \
                echo "<name>: Banned <ip> with rule ID $id"; \
            else \
                echo "<name>: Failed to ban <ip>"; \
                echo "Response: $response" >&2; \
            fi

actionunban = id=$(curl -s -X GET "https://api.cloudflare.com/v4/zones/<cfzone>/firewall/access_rules/rules?configuration.target=ip&configuration.value=<ip>&notes=Fail2Ban%%20<name>" \
                   -H "Authorization: Bearer <cftoken>" \
                   | { jq -r '.result[0].id // empty' 2>/dev/null || sed -nE 's/.*"result":\[{"id":"([^"]+)".*/\1/p'; }); \
              # If no rule found, exit cleanly
              if [ -z "$id" ]; then \
                  echo "<name>: Rule for <ip> not found, may already be unbanned"; \
                  exit 0; \
              fi; \
              # Attempt to delete the rule using the ID
              response=$(curl -s -X DELETE "https://api.cloudflare.com/v4/zones/<cfzone>/firewall/access_rules/rules/$id" \
                         -H "Authorization: Bearer <cftoken>"); \
              # Parse and validate the result
              success=$(echo "$response" | { jq -r '.success // false' 2>/dev/null || echo "false"; }); \
              if [ "$success" = "true" ]; then \
                  echo "<name>: Unbanned <ip> (rule ID $id)"; \
              else \
                  echo "<name>: Failed to unban <ip> (rule ID $id)"; \
                  echo "Response: $response" >&2; \
              fi

actionstart =
actionstop = 
actioncheck =

[Init]
cfzone = 
cftoken =
